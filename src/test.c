#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include <sys/time.h>


#include <stdint.h>
#include <stddef.h>

static inline void q7_add_to_q31(
    const int8_t * __restrict srcA,
    const int8_t * __restrict srcB,
    int32_t       * __restrict dst,
    size_t          blockSize
) {
    size_t i = 0;
    // unroll 4 at a time
    for (; i + 3 < blockSize; i += 4) {
        dst[i]   = (((int32_t)srcA[i]   << 24)
                    + ((int32_t)srcB[i]   << 24));
        dst[i+1] = (((int32_t)srcA[i+1] << 24)
                    + ((int32_t)srcB[i+1] << 24));
        dst[i+2] = (((int32_t)srcA[i+2] << 24)
                    + ((int32_t)srcB[i+2] << 24));
        dst[i+3] = (((int32_t)srcA[i+3] << 24)
                    + ((int32_t)srcB[i+3] << 24));
    }
    // leftover
    for (; i < blockSize; i++) {
        dst[i] = (((int32_t)srcA[i] << 24)
                + ((int32_t)srcB[i] << 24));
    }
}


#define INPUT_SIZE 512

int main() {

    // Example usage of q7_to_q31 and add_q31 functions
    int8_t srcA[INPUT_SIZE] = {1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8,1, 2, 3, 4, 5, 6, 7, 8};
    int8_t srcB[INPUT_SIZE] = {8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1,8, 7, 6, 5, 4, 3, 2, 1};
    size_t blockSize = INPUT_SIZE;

    struct timeval start, end;

    // Add the two Q31 arrays
    int32_t result[INPUT_SIZE] = {0};
        gettimeofday(&start, NULL);
    add_q31(srcA, srcB, result, blockSize);
        gettimeofday(&end, NULL);

    // Print the result
    printf("Q31 addition result:\n");
    // for (size_t i = 0; i < blockSize; i++) {
    //     printf("result[%zu] = %d\n", i, result[i]);
    // }
    printf( "CPU run time = %0.6f s\n", (float)(end.tv_sec - start.tv_sec\
                + (end.tv_usec - start.tv_usec) / (float)1000000));


    // Add them tradionally
    int32_t result_2[INPUT_SIZE] = {0};
        gettimeofday(&start, NULL);
    for (size_t i = 0; i < blockSize; i++) {
        result_2[i] = ((int32_t)srcA[i] << 24) + ((int32_t)srcB[i] << 24);
    }
        gettimeofday(&end, NULL);
    printf("\nTraditional addition:\n");
    // for (size_t i = 0; i < blockSize; i++) {
    //     printf("result[%zu] = %d\n", i, result[i]);
    // }
    printf( "CPU run time = %0.6f s\n", (float)(end.tv_sec - start.tv_sec\
                + (end.tv_usec - start.tv_usec) / (float)1000000));

    return 0;

}